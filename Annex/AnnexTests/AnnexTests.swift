import Testing
import Foundation
import SwiftUI
@testable import Annex

// MARK: - Model Decoding Tests

struct ModelDecodingTests {
    @Test func decodePairResponse() throws {
        let json = """
        {"token": "550e8400-e29b-41d4-a716-446655440000"}
        """
        let response = try JSONDecoder().decode(PairResponse.self, from: Data(json.utf8))
        #expect(response.token == "550e8400-e29b-41d4-a716-446655440000")
    }

    @Test func decodeStatusResponse() throws {
        let json = """
        {"version":"1","deviceName":"Clubhouse on Mason's Mac","agentCount":5,"orchestratorCount":1}
        """
        let response = try JSONDecoder().decode(StatusResponse.self, from: Data(json.utf8))
        #expect(response.version == "1")
        #expect(response.deviceName == "Clubhouse on Mason's Mac")
        #expect(response.agentCount == 5)
        #expect(response.orchestratorCount == 1)
    }

    @Test func decodeErrorResponse() throws {
        let json = """
        {"error": "invalid_pin"}
        """
        let response = try JSONDecoder().decode(ErrorResponse.self, from: Data(json.utf8))
        #expect(response.error == "invalid_pin")
    }

    @Test func decodeProject() throws {
        let json = """
        {"id":"proj_abc123","name":"my-app","path":"/Users/mason/source/my-app","color":"emerald","icon":null,"displayName":"My App","orchestrator":"claude-code"}
        """
        let project = try JSONDecoder().decode(Project.self, from: Data(json.utf8))
        #expect(project.id == "proj_abc123")
        #expect(project.name == "my-app")
        #expect(project.color == "emerald")
        #expect(project.displayName == "My App")
        #expect(project.label == "My App")
    }

    @Test func decodeProjectWithoutDisplayName() throws {
        let json = """
        {"id":"proj_1","name":"api-server","path":"/path","color":null,"icon":null,"displayName":null,"orchestrator":null}
        """
        let project = try JSONDecoder().decode(Project.self, from: Data(json.utf8))
        #expect(project.label == "api-server")
    }

    @Test func decodeDurableAgent() throws {
        let json = """
        {"id":"durable_1737000000000_abc123","name":"faithful-urchin","kind":"durable","color":"emerald","branch":"faithful-urchin/standby","model":"claude-opus-4-5","orchestrator":"claude-code","freeAgentMode":false,"icon":null}
        """
        let agent = try JSONDecoder().decode(DurableAgent.self, from: Data(json.utf8))
        #expect(agent.id == "durable_1737000000000_abc123")
        #expect(agent.name == "faithful-urchin")
        #expect(agent.kind == "durable")
        #expect(agent.freeAgentMode == false)
        #expect(agent.orchestrator == "claude-code")
    }

    @Test func decodeOrchestratorEntry() throws {
        let json = """
        {"displayName":"Claude Code","shortName":"CC","badge":null}
        """
        let entry = try JSONDecoder().decode(OrchestratorEntry.self, from: Data(json.utf8))
        #expect(entry.displayName == "Claude Code")
        #expect(entry.shortName == "CC")
        #expect(entry.badge == nil)
    }

    @Test func decodeThemeColors() throws {
        let json = """
        {"base":"#1e1e2e","mantle":"#181825","crust":"#11111b","text":"#cdd6f4","subtext0":"#a6adc8","subtext1":"#bac2de","surface0":"#313244","surface1":"#45475a","surface2":"#585b70","accent":"#89b4fa","link":"#89b4fa"}
        """
        let theme = try JSONDecoder().decode(ThemeColors.self, from: Data(json.utf8))
        #expect(theme.base == "#1e1e2e")
        #expect(theme.accent == "#89b4fa")
        #expect(theme.isDark == true)
    }
}

// MARK: - WebSocket Message Parsing Tests

struct WSMessageParsingTests {
    @Test func decodeSnapshotMessage() throws {
        let json = """
        {
            "type": "snapshot",
            "payload": {
                "projects": [
                    {"id":"p1","name":"test","path":"/test","color":null,"icon":null,"displayName":null,"orchestrator":null}
                ],
                "agents": {},
                "theme": {"base":"#1e1e2e","mantle":"#181825","crust":"#11111b","text":"#cdd6f4","subtext0":"#a6adc8","subtext1":"#bac2de","surface0":"#313244","surface1":"#45475a","surface2":"#585b70","accent":"#89b4fa","link":"#89b4fa"},
                "orchestrators": {}
            }
        }
        """
        // Verify the envelope decodes
        let envelope = try JSONDecoder().decode(WSMessage.self, from: Data(json.utf8))
        #expect(envelope.type == "snapshot")

        // Verify the snapshot payload decodes
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let snapshot = try JSONDecoder().decode(PayloadExtractor<SnapshotPayload>.self, from: Data(json.utf8))
        #expect(snapshot.payload.projects.count == 1)
        #expect(snapshot.payload.projects[0].id == "p1")
    }

    @Test func decodePtyDataMessage() throws {
        let json = """
        {"type":"pty:data","payload":{"agentId":"agent_1","data":"Hello world\\n"}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<PtyDataPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.agentId == "agent_1")
        #expect(msg.payload.data == "Hello world\n")
    }

    @Test func decodePtyExitMessage() throws {
        let json = """
        {"type":"pty:exit","payload":{"agentId":"agent_1","exitCode":0}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<PtyExitPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.agentId == "agent_1")
        #expect(msg.payload.exitCode == 0)
    }

    @Test func decodeHookEventMessage() throws {
        let json = """
        {"type":"hook:event","payload":{"agentId":"agent_1","event":{"kind":"pre_tool","toolName":"EditFile","toolInput":{"path":"/src/main.ts"},"message":null,"toolVerb":"Editing file","timestamp":1737000000000}}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<HookEventPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.agentId == "agent_1")
        #expect(msg.payload.event.kind == .preTool)
        #expect(msg.payload.event.toolName == "EditFile")
        #expect(msg.payload.event.toolVerb == "Editing file")
        #expect(msg.payload.event.timestamp == 1737000000000)
    }

    @Test func decodeThemeChangedMessage() throws {
        let json = """
        {"type":"theme:changed","payload":{"base":"#1e1e2e","mantle":"#181825","crust":"#11111b","text":"#cdd6f4","subtext0":"#a6adc8","subtext1":"#bac2de","surface0":"#313244","surface1":"#45475a","surface2":"#585b70","accent":"#f38ba8","link":"#f38ba8"}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<ThemeColors>.self, from: Data(json.utf8))
        #expect(msg.payload.accent == "#f38ba8")
    }

    @Test func hookEventConversion() throws {
        let serverEvent = ServerHookEvent(
            kind: .preTool,
            toolName: "Read",
            toolInput: .object(["path": .string("/src/main.ts")]),
            message: nil,
            toolVerb: "Reading file",
            timestamp: 1737000000000
        )
        let hookEvent = serverEvent.toHookEvent(agentId: "agent_1")
        #expect(hookEvent.agentId == "agent_1")
        #expect(hookEvent.kind == .preTool)
        #expect(hookEvent.toolName == "Read")
        #expect(hookEvent.toolVerb == "Reading file")
        #expect(hookEvent.timestamp == 1737000000000)
    }
}

// MARK: - HookEventKind Tests

struct HookEventKindTests {
    @Test func decodeAllKinds() throws {
        let kinds: [(String, HookEventKind)] = [
            ("\"pre_tool\"", .preTool),
            ("\"post_tool\"", .postTool),
            ("\"tool_error\"", .toolError),
            ("\"stop\"", .stop),
            ("\"notification\"", .notification),
            ("\"permission_request\"", .permissionRequest),
        ]
        for (json, expected) in kinds {
            let decoded = try JSONDecoder().decode(HookEventKind.self, from: Data(json.utf8))
            #expect(decoded == expected)
        }
    }
}

// MARK: - QuickAgent Model Tests

struct QuickAgentTests {
    @Test func decodeQuickAgentMinimal() throws {
        let json = """
        {"id":"quick_001","kind":"quick"}
        """
        let agent = try JSONDecoder().decode(QuickAgent.self, from: Data(json.utf8))
        #expect(agent.id == "quick_001")
        #expect(agent.kind == "quick")
        #expect(agent.name == nil)
        #expect(agent.prompt == nil)
        #expect(agent.summary == nil)
    }

    @Test func decodeQuickAgentFull() throws {
        let json = """
        {"id":"quick_001","name":"quick-agent-1","kind":"quick","status":"running","mission":"Fix bug","prompt":"Fix the login bug","model":"claude-sonnet-4-5","orchestrator":"claude-code","parentAgentId":"durable_001","projectId":"proj_001","freeAgentMode":false}
        """
        let agent = try JSONDecoder().decode(QuickAgent.self, from: Data(json.utf8))
        #expect(agent.id == "quick_001")
        #expect(agent.name == "quick-agent-1")
        #expect(agent.status == .running)
        #expect(agent.prompt == "Fix the login bug")
        #expect(agent.model == "claude-sonnet-4-5")
        #expect(agent.parentAgentId == "durable_001")
        #expect(agent.projectId == "proj_001")
        #expect(agent.freeAgentMode == false)
    }

    @Test func decodeQuickAgentWithCompletionData() throws {
        let json = """
        {"id":"quick_001","kind":"quick","status":"completed","summary":"Fixed the bug","filesModified":["src/main.ts","src/test.ts"],"durationMs":45200,"costUsd":0.12,"toolsUsed":["Read","Edit","Bash"]}
        """
        let agent = try JSONDecoder().decode(QuickAgent.self, from: Data(json.utf8))
        #expect(agent.status == .completed)
        #expect(agent.summary == "Fixed the bug")
        #expect(agent.filesModified == ["src/main.ts", "src/test.ts"])
        #expect(agent.durationMs == 45200)
        #expect(agent.costUsd == 0.12)
        #expect(agent.toolsUsed == ["Read", "Edit", "Bash"])
    }

    @Test func quickAgentLabel() {
        let withName = QuickAgent(id: "q1", name: "my-agent", kind: "quick", status: nil, mission: nil, prompt: "some prompt", model: nil, detailedStatus: nil, orchestrator: nil, parentAgentId: nil, projectId: nil, freeAgentMode: nil)
        #expect(withName.label == "my-agent")

        let withPrompt = QuickAgent(id: "q2", name: nil, kind: "quick", status: nil, mission: nil, prompt: "Fix the auth flow in the login page", model: nil, detailedStatus: nil, orchestrator: nil, parentAgentId: nil, projectId: nil, freeAgentMode: nil)
        #expect(withPrompt.label == "Fix the auth flow in the login page")

        let idOnly = QuickAgent(id: "q3", name: nil, kind: "quick", status: nil, mission: nil, prompt: nil, model: nil, detailedStatus: nil, orchestrator: nil, parentAgentId: nil, projectId: nil, freeAgentMode: nil)
        #expect(idOnly.label == "q3")
    }
}

// MARK: - Agent Status Tests

struct AgentStatusTests {
    @Test func decodeAllStatuses() throws {
        let statuses: [(String, AgentStatus)] = [
            ("\"starting\"", .starting),
            ("\"running\"", .running),
            ("\"sleeping\"", .sleeping),
            ("\"error\"", .error),
            ("\"completed\"", .completed),
            ("\"failed\"", .failed),
            ("\"cancelled\"", .cancelled),
        ]
        for (json, expected) in statuses {
            let decoded = try JSONDecoder().decode(AgentStatus.self, from: Data(json.utf8))
            #expect(decoded == expected)
        }
    }
}

// MARK: - Request/Response Model Tests

struct AgentActionModelTests {
    @Test func encodeSpawnQuickAgentRequest() throws {
        let request = SpawnQuickAgentRequest(
            prompt: "Fix the bug",
            orchestrator: "claude-code",
            model: "claude-sonnet-4-5",
            freeAgentMode: false,
            systemPrompt: nil
        )
        let data = try JSONEncoder().encode(request)
        let decoded = try JSONDecoder().decode(SpawnQuickAgentRequest.self, from: data)
        #expect(decoded.prompt == "Fix the bug")
        #expect(decoded.orchestrator == "claude-code")
        #expect(decoded.model == "claude-sonnet-4-5")
        #expect(decoded.freeAgentMode == false)
        #expect(decoded.systemPrompt == nil)
    }

    @Test func encodeWakeAgentRequest() throws {
        let request = WakeAgentRequest(message: "Rebase on main", model: "claude-opus-4-5")
        let data = try JSONEncoder().encode(request)
        let decoded = try JSONDecoder().decode(WakeAgentRequest.self, from: data)
        #expect(decoded.message == "Rebase on main")
        #expect(decoded.model == "claude-opus-4-5")
    }

    @Test func encodeWakeAgentRequestNoModel() throws {
        let request = WakeAgentRequest(message: "Fix tests", model: nil)
        let data = try JSONEncoder().encode(request)
        let decoded = try JSONDecoder().decode(WakeAgentRequest.self, from: data)
        #expect(decoded.message == "Fix tests")
        #expect(decoded.model == nil)
    }

    @Test func encodeSendMessageRequest() throws {
        let request = SendMessageRequest(message: "Also update the README")
        let data = try JSONEncoder().encode(request)
        let decoded = try JSONDecoder().decode(SendMessageRequest.self, from: data)
        #expect(decoded.message == "Also update the README")
    }

    @Test func decodeSpawnQuickAgentResponse() throws {
        let json = """
        {"id":"quick_001","name":"quick-agent-1","kind":"quick","status":"starting","prompt":"Fix bug","model":"claude-sonnet-4-5","orchestrator":"claude-code","freeAgentMode":false,"parentAgentId":null,"projectId":"proj_001"}
        """
        let response = try JSONDecoder().decode(SpawnQuickAgentResponse.self, from: Data(json.utf8))
        #expect(response.id == "quick_001")
        #expect(response.kind == "quick")
        #expect(response.status == "starting")
        #expect(response.prompt == "Fix bug")
        #expect(response.projectId == "proj_001")
        #expect(response.parentAgentId == nil)
    }

    @Test func decodeWakeAgentResponse() throws {
        let json = """
        {"id":"durable_001","name":"faithful-urchin","kind":"durable","color":"emerald","status":"starting","branch":"faithful-urchin/standby","model":"claude-sonnet-4-5","orchestrator":"claude-code","freeAgentMode":false,"icon":null,"detailedStatus":null}
        """
        let response = try JSONDecoder().decode(WakeAgentResponse.self, from: Data(json.utf8))
        #expect(response.id == "durable_001")
        #expect(response.status == "starting")
        #expect(response.name == "faithful-urchin")
        #expect(response.detailedStatus == nil)
    }

    @Test func decodeCancelAgentResponse() throws {
        let json = """
        {"id":"quick_001","status":"cancelled"}
        """
        let response = try JSONDecoder().decode(CancelAgentResponse.self, from: Data(json.utf8))
        #expect(response.id == "quick_001")
        #expect(response.status == "cancelled")
    }

    @Test func decodeSendMessageResponse() throws {
        let json = """
        {"id":"durable_001","status":"running","delivered":true}
        """
        let response = try JSONDecoder().decode(SendMessageResponse.self, from: Data(json.utf8))
        #expect(response.id == "durable_001")
        #expect(response.delivered == true)
    }
}

// MARK: - New WebSocket Payload Tests

struct AgentWSPayloadTests {
    @Test func decodeAgentSpawnedPayload() throws {
        let json = """
        {"type":"agent:spawned","payload":{"id":"quick_001","kind":"quick","status":"starting","prompt":"Fix bug","model":"claude-sonnet-4-5","orchestrator":"claude-code","freeAgentMode":false,"parentAgentId":"durable_001","projectId":"proj_001"}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<AgentSpawnedPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.id == "quick_001")
        #expect(msg.payload.kind == "quick")
        #expect(msg.payload.status == "starting")
        #expect(msg.payload.prompt == "Fix bug")
        #expect(msg.payload.parentAgentId == "durable_001")
        #expect(msg.payload.projectId == "proj_001")
    }

    @Test func decodeAgentStatusPayload() throws {
        let json = """
        {"type":"agent:status","payload":{"id":"quick_001","kind":"quick","status":"running","projectId":"proj_001","parentAgentId":"durable_001"}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<AgentStatusPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.id == "quick_001")
        #expect(msg.payload.status == "running")
        #expect(msg.payload.projectId == "proj_001")
    }

    @Test func decodeAgentCompletedPayload() throws {
        let json = """
        {"type":"agent:completed","payload":{"id":"quick_001","kind":"quick","status":"completed","exitCode":0,"projectId":"proj_001","parentAgentId":null,"summary":"Fixed the bug","filesModified":["src/main.ts"],"durationMs":45200,"costUsd":0.12,"toolsUsed":["Read","Edit"]}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<AgentCompletedPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.id == "quick_001")
        #expect(msg.payload.status == "completed")
        #expect(msg.payload.exitCode == 0)
        #expect(msg.payload.summary == "Fixed the bug")
        #expect(msg.payload.filesModified == ["src/main.ts"])
        #expect(msg.payload.durationMs == 45200)
        #expect(msg.payload.costUsd == 0.12)
        #expect(msg.payload.toolsUsed == ["Read", "Edit"])
    }

    @Test func decodeAgentCompletedPayloadMinimal() throws {
        let json = """
        {"type":"agent:completed","payload":{"id":"quick_001","kind":"quick","status":"failed","exitCode":1,"projectId":"proj_001"}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<AgentCompletedPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.status == "failed")
        #expect(msg.payload.exitCode == 1)
        #expect(msg.payload.summary == nil)
        #expect(msg.payload.filesModified == nil)
    }

    @Test func decodeAgentWokenPayload() throws {
        let json = """
        {"type":"agent:woken","payload":{"agentId":"durable_001","message":"Rebase on main","source":"annex"}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<AgentWokenPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.agentId == "durable_001")
        #expect(msg.payload.message == "Rebase on main")
        #expect(msg.payload.source == "annex")
    }

    @Test func decodeSnapshotWithQuickAgents() throws {
        let json = """
        {
            "type": "snapshot",
            "payload": {
                "projects": [{"id":"p1","name":"test","path":"/test","color":null,"icon":null,"displayName":null,"orchestrator":null}],
                "agents": {},
                "quickAgents": {
                    "p1": [{"id":"quick_001","kind":"quick","status":"running","prompt":"Fix bug","model":"claude-sonnet-4-5","projectId":"p1"}]
                },
                "theme": {"base":"#1e1e2e","mantle":"#181825","crust":"#11111b","text":"#cdd6f4","subtext0":"#a6adc8","subtext1":"#bac2de","surface0":"#313244","surface1":"#45475a","surface2":"#585b70","accent":"#89b4fa","link":"#89b4fa"},
                "orchestrators": {}
            }
        }
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let snapshot = try JSONDecoder().decode(PayloadExtractor<SnapshotPayload>.self, from: Data(json.utf8))
        #expect(snapshot.payload.quickAgents?["p1"]?.count == 1)
        #expect(snapshot.payload.quickAgents?["p1"]?[0].id == "quick_001")
        #expect(snapshot.payload.quickAgents?["p1"]?[0].prompt == "Fix bug")
    }

    @Test func decodeSnapshotWithoutQuickAgents() throws {
        let json = """
        {
            "type": "snapshot",
            "payload": {
                "projects": [],
                "agents": {},
                "theme": {"base":"#1e1e2e","mantle":"#181825","crust":"#11111b","text":"#cdd6f4","subtext0":"#a6adc8","subtext1":"#bac2de","surface0":"#313244","surface1":"#45475a","surface2":"#585b70","accent":"#89b4fa","link":"#89b4fa"},
                "orchestrators": {}
            }
        }
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let snapshot = try JSONDecoder().decode(PayloadExtractor<SnapshotPayload>.self, from: Data(json.utf8))
        #expect(snapshot.payload.quickAgents == nil)
    }
}

// MARK: - API Client Tests

struct APIClientTests {
    @Test func urlConstruction() throws {
        let client = AnnexAPIClient(host: "192.168.1.100", port: 8080)
        #expect(client.baseURL == "http://192.168.1.100:8080")
    }

    @Test func webSocketURLConstruction() throws {
        let client = AnnexAPIClient(host: "192.168.1.100", port: 8080)
        let url = try client.webSocketURL(token: "test-token-123")
        #expect(url.absoluteString == "ws://192.168.1.100:8080/ws?token=test-token-123")
    }
}

// MARK: - AppStore Tests

@MainActor
struct AppStoreTests {
    @Test func initialState() {
        let store = AppStore()
        #expect(store.isPaired == false)
        #expect(store.projects.isEmpty)
        #expect(store.agentsByProject.isEmpty)
        #expect(store.totalAgentCount == 0)
        #expect(store.connectionState.isConnected == false)
    }

    @Test func loadMockData() {
        let store = AppStore()
        store.loadMockData()
        #expect(store.isPaired == true)
        #expect(store.projects.count == 3)
        #expect(store.totalAgentCount == 5)
        #expect(store.serverName == "Clubhouse on Mason's Mac")
        #expect(store.connectionState.isConnected == true)
    }

    @Test func disconnect() {
        let store = AppStore()
        store.loadMockData()
        store.completeOnboarding()
        store.disconnect()
        #expect(store.isPaired == false)
        #expect(store.projects.isEmpty)
        #expect(store.agentsByProject.isEmpty)
        #expect(store.serverName == "")
        #expect(store.connectionState.isConnected == false)
        // Disconnect preserves onboarding state
        #expect(store.hasCompletedOnboarding == true)
    }

    @Test func resetApp() {
        UserDefaults.standard.removeObject(forKey: "hasCompletedOnboarding")
        let store = AppStore()
        store.loadMockData()
        store.completeOnboarding()
        #expect(store.hasCompletedOnboarding == true)
        store.resetApp()
        #expect(store.isPaired == false)
        #expect(store.projects.isEmpty)
        #expect(store.hasCompletedOnboarding == false)
    }

    @Test func completeOnboarding() {
        // Clear any leftover state from other tests
        UserDefaults.standard.removeObject(forKey: "hasCompletedOnboarding")
        let store = AppStore()
        #expect(store.hasCompletedOnboarding == false)
        store.completeOnboarding()
        #expect(store.hasCompletedOnboarding == true)
    }

    @Test func agentsForProject() {
        let store = AppStore()
        store.loadMockData()
        let proj = store.projects[0]
        let agents = store.agents(for: proj)
        #expect(!agents.isEmpty)
    }

    @Test func activityForAgent() {
        let store = AppStore()
        store.loadMockData()
        let events = store.activity(for: "durable_1737000000000_abc123")
        #expect(!events.isEmpty)
    }

    @Test func runningAgentCount() {
        let store = AppStore()
        store.loadMockData()
        #expect(store.runningAgentCount > 0)
        #expect(store.runningAgentCount <= store.totalAgentCount)
    }

    @Test func quickAgentsForProject() {
        let store = AppStore()
        store.loadMockData()
        let proj = store.projects[0] // proj_001
        let quickAgents = store.allQuickAgents(for: proj)
        // proj_001 has one quick agent nested under faithful-urchin
        #expect(!quickAgents.isEmpty)
        #expect(quickAgents[0].id == "quick_1737000100000_def456")
    }

    @Test func quickAgentsDeduplication() {
        let store = AppStore()
        store.loadMockData()
        let proj = store.projects[0]

        // Add the same quick agent to standalone list
        let qa = QuickAgent(id: "quick_1737000100000_def456", name: "quick-agent-1", kind: "quick", status: .running, mission: nil, prompt: "Fix bug", model: nil, detailedStatus: nil, orchestrator: nil, parentAgentId: nil, projectId: "proj_001", freeAgentMode: nil)
        store.quickAgentsByProject["proj_001"] = [qa]

        let all = store.allQuickAgents(for: proj)
        // Should deduplicate — only one entry for the same ID
        let ids = all.map(\.id)
        let uniqueIds = Set(ids)
        #expect(ids.count == uniqueIds.count)
    }

    @Test func disconnectClearsQuickAgents() {
        let store = AppStore()
        store.loadMockData()
        let qa = QuickAgent(id: "q1", name: nil, kind: "quick", status: .running, mission: nil, prompt: "test", model: nil, detailedStatus: nil, orchestrator: nil, parentAgentId: nil, projectId: "proj_001", freeAgentMode: nil)
        store.quickAgentsByProject["proj_001"] = [qa]
        #expect(!store.quickAgentsByProject.isEmpty)
        store.disconnect()
        #expect(store.quickAgentsByProject.isEmpty)
    }

    @Test func removeQuickAgent() {
        let store = AppStore()
        let qa1 = QuickAgent(id: "q1", name: nil, kind: "quick", status: .completed, mission: nil, prompt: "task 1", model: nil, detailedStatus: nil, orchestrator: nil, parentAgentId: nil, projectId: "proj_001", freeAgentMode: nil)
        let qa2 = QuickAgent(id: "q2", name: nil, kind: "quick", status: .running, mission: nil, prompt: "task 2", model: nil, detailedStatus: nil, orchestrator: nil, parentAgentId: nil, projectId: "proj_001", freeAgentMode: nil)
        store.quickAgentsByProject["proj_001"] = [qa1, qa2]

        store.removeQuickAgent(agentId: "q1")
        #expect(store.quickAgentsByProject["proj_001"]?.count == 1)
        #expect(store.quickAgentsByProject["proj_001"]?[0].id == "q2")
    }

    @Test func removeQuickAgentNonexistent() {
        let store = AppStore()
        let qa = QuickAgent(id: "q1", name: nil, kind: "quick", status: .running, mission: nil, prompt: "test", model: nil, detailedStatus: nil, orchestrator: nil, parentAgentId: nil, projectId: "proj_001", freeAgentMode: nil)
        store.quickAgentsByProject["proj_001"] = [qa]

        store.removeQuickAgent(agentId: "nonexistent")
        #expect(store.quickAgentsByProject["proj_001"]?.count == 1)
    }

    @Test func iconURLsRequireConnection() {
        let store = AppStore()
        // No apiClient or token set — should return nil
        #expect(store.agentIconURL(agentId: "agent_1") == nil)
        #expect(store.projectIconURL(projectId: "proj_1") == nil)
    }

    @Test func projectIconsAccessibleForAgentProjects() {
        let store = AppStore()
        store.loadMockData()

        // Pick an agent and find its project
        let agent = store.allAgents.first!
        let agentProject = store.project(for: agent)
        #expect(agentProject != nil)

        // Simulate storing icon data for that project
        let fakeIconData = Data([0x89, 0x50, 0x4E, 0x47]) // PNG magic bytes
        store.projectIcons[agentProject!.id] = fakeIconData

        // Verify icon data is retrievable by the same project ID
        let iconData = store.projectIcons[agentProject!.id]
        #expect(iconData != nil)
        #expect(iconData == fakeIconData)
    }

    @Test func projectIconsEmptyByDefault() {
        let store = AppStore()
        store.loadMockData()
        // No icons fetched yet — dictionary should be empty
        #expect(store.projectIcons.isEmpty)
        // Looking up icon data should return nil (triggers default letter icon)
        let project = store.projects[0]
        #expect(store.projectIcons[project.id] == nil)
    }
}

// MARK: - JSONValue Tests

struct JSONValueTests {
    @Test func decodeString() throws {
        let json = "\"hello\""
        let value = try JSONDecoder().decode(JSONValue.self, from: Data(json.utf8))
        #expect(value == .string("hello"))
    }

    @Test func decodeNumber() throws {
        let json = "42"
        let value = try JSONDecoder().decode(JSONValue.self, from: Data(json.utf8))
        #expect(value == .number(42.0))
    }

    @Test func decodeBool() throws {
        let json = "true"
        let value = try JSONDecoder().decode(JSONValue.self, from: Data(json.utf8))
        #expect(value == .bool(true))
    }

    @Test func decodeNull() throws {
        let json = "null"
        let value = try JSONDecoder().decode(JSONValue.self, from: Data(json.utf8))
        #expect(value == .null)
    }

    @Test func decodeObject() throws {
        let json = """
        {"key": "value", "num": 1}
        """
        let value = try JSONDecoder().decode(JSONValue.self, from: Data(json.utf8))
        if case .object(let dict) = value {
            #expect(dict["key"] == .string("value"))
            #expect(dict["num"] == .number(1.0))
        } else {
            #expect(Bool(false), "Expected object")
        }
    }

    @Test func decodeArray() throws {
        let json = "[1, \"two\", true]"
        let value = try JSONDecoder().decode(JSONValue.self, from: Data(json.utf8))
        if case .array(let arr) = value {
            #expect(arr.count == 3)
            #expect(arr[0] == .number(1.0))
            #expect(arr[1] == .string("two"))
            #expect(arr[2] == .bool(true))
        } else {
            #expect(Bool(false), "Expected array")
        }
    }
}

// MARK: - ConnectionState Tests

struct ConnectionStateTests {
    @Test func labels() {
        #expect(ConnectionState.disconnected.label == "Disconnected")
        #expect(ConnectionState.connected.label == "Connected")
        #expect(ConnectionState.connecting.label == "Connecting...")
        #expect(ConnectionState.reconnecting(attempt: 3).label == "Reconnecting (3)...")
    }

    @Test func isConnected() {
        #expect(ConnectionState.connected.isConnected == true)
        #expect(ConnectionState.disconnected.isConnected == false)
        #expect(ConnectionState.reconnecting(attempt: 1).isConnected == false)
    }
}

// MARK: - Initials Extraction Tests

struct InitialsTests {
    @Test func agentInitialsTwoWords() {
        #expect(agentInitials(from: "gallant-swift") == "GS")
        #expect(agentInitials(from: "bold-falcon") == "BF")
        #expect(agentInitials(from: "lucky-mantis") == "LM")
    }

    @Test func agentInitialsSingleWord() {
        #expect(agentInitials(from: "agent") == "A")
    }

    @Test func agentInitialsEmpty() {
        #expect(agentInitials(from: "") == "")
        #expect(agentInitials(from: nil) == "")
    }

    @Test func agentInitialsThreeWords() {
        #expect(agentInitials(from: "big-red-fox") == "BR")
    }

    @Test func projectInitialFromDisplayName() {
        #expect(projectInitial(from: "My App", name: "my-app") == "M")
        #expect(projectInitial(from: "SourceKit", name: "sourcekit") == "S")
    }

    @Test func projectInitialFallsBackToName() {
        #expect(projectInitial(from: nil, name: "my-app") == "M")
        #expect(projectInitial(from: nil, name: "SourceKit") == "S")
    }

    @Test func projectInitialEmptyName() {
        #expect(projectInitial(from: nil, name: "") == "")
    }
}

// MARK: - All Agents View Support Tests

@MainActor
struct AllAgentsTests {
    @Test func allAgentsSortedByStatus() {
        let store = AppStore()
        store.loadMockData()
        let agents = store.allAgents
        // Should have all 5 agents
        #expect(agents.count == 5)
        // Running agents should come before sleeping/error
        let statuses = agents.compactMap(\.status)
        // First agents should be running
        let firstRunningIndex = statuses.firstIndex(of: .running)
        let firstSleepingIndex = statuses.firstIndex(of: .sleeping)
        if let r = firstRunningIndex, let s = firstSleepingIndex {
            #expect(r < s)
        }
    }

    @Test func allAgentsActiveBeforeInactive() {
        let store = AppStore()
        store.loadMockData()
        let agents = store.allAgents
        // Find the boundary: all running/error agents should precede sleeping ones
        var seenInactive = false
        for agent in agents {
            let isActive = agent.status == .running || agent.status == .starting
            if !isActive {
                seenInactive = true
            }
            if seenInactive && isActive {
                Issue.record("Active agent found after inactive agent — sorting is wrong")
            }
        }
    }

    @Test func projectLookupFindsCorrectProject() {
        let store = AppStore()
        store.loadMockData()
        let agents = store.allAgents
        guard let firstAgent = agents.first else {
            Issue.record("No agents found")
            return
        }
        let project = store.project(for: firstAgent)
        #expect(project != nil)
    }

    @Test func projectLookupReturnsNilForUnknown() {
        let store = AppStore()
        store.loadMockData()
        let unknown = DurableAgent(
            id: "unknown_id",
            name: "ghost",
            kind: "durable",
            color: nil,
            branch: nil,
            model: nil,
            orchestrator: nil,
            freeAgentMode: nil,
            icon: nil
        )
        let project = store.project(for: unknown)
        #expect(project == nil)
    }

    @Test func statusSortOrder() {
        let running = DurableAgent(id: "1", name: nil, kind: nil, color: nil, branch: nil, model: nil, orchestrator: nil, freeAgentMode: nil, icon: nil, status: .running)
        let sleeping = DurableAgent(id: "2", name: nil, kind: nil, color: nil, branch: nil, model: nil, orchestrator: nil, freeAgentMode: nil, icon: nil, status: .sleeping)
        let errored = DurableAgent(id: "3", name: nil, kind: nil, color: nil, branch: nil, model: nil, orchestrator: nil, freeAgentMode: nil, icon: nil, status: .error)
        let completed = DurableAgent(id: "4", name: nil, kind: nil, color: nil, branch: nil, model: nil, orchestrator: nil, freeAgentMode: nil, icon: nil, status: .completed)
        let noStatus = DurableAgent(id: "5", name: nil, kind: nil, color: nil, branch: nil, model: nil, orchestrator: nil, freeAgentMode: nil, icon: nil)

        #expect(running.statusSortOrder < errored.statusSortOrder)
        #expect(errored.statusSortOrder < sleeping.statusSortOrder)
        #expect(sleeping.statusSortOrder < completed.statusSortOrder)
        #expect(completed.statusSortOrder < noStatus.statusSortOrder)
    }

    @Test func allAgentsEmptyWhenNoData() {
        let store = AppStore()
        #expect(store.allAgents.isEmpty)
    }

    @Test func projectLookupMapsCorrectly() {
        let store = AppStore()
        store.loadMockData()
        // faithful-urchin belongs to proj_001 ("My App")
        let faithfulUrchin = store.allAgents.first { $0.name == "faithful-urchin" }
        #expect(faithfulUrchin != nil)
        let project = store.project(for: faithfulUrchin!)
        #expect(project?.id == "proj_001")
        #expect(project?.label == "My App")

        // bold-eagle belongs to proj_002 ("api-server")
        let boldEagle = store.allAgents.first { $0.name == "bold-eagle" }
        #expect(boldEagle != nil)
        let project2 = store.project(for: boldEagle!)
        #expect(project2?.id == "proj_002")
    }
}

// MARK: - AgentColor Tests

struct AgentColorTests {
    @Test func allColorsHaveHex() {
        for color in AgentColor.allCases {
            #expect(color.hex.hasPrefix("#"))
            #expect(color.hex.count == 7)
        }
    }

    @Test func colorForId() {
        let color = AgentColor.color(for: "emerald")
        #expect(color != .gray)
    }

    @Test func colorForInvalidId() {
        let color = AgentColor.color(for: "nonexistent")
        #expect(color == .gray)
    }
}

// MARK: - Permission Model Tests

struct PermissionModelTests {
    @Test func decodePermissionRequest() throws {
        let json = """
        {"id":"perm_001","agentId":"durable_001","toolName":"Bash","toolInput":{"command":"rm -rf /tmp/test"},"message":"Run shell command","deadline":1737000120000}
        """
        let perm = try JSONDecoder().decode(PermissionRequest.self, from: Data(json.utf8))
        #expect(perm.id == "perm_001")
        #expect(perm.agentId == "durable_001")
        #expect(perm.toolName == "Bash")
        #expect(perm.message == "Run shell command")
        #expect(perm.deadline == 1737000120000)
        if case .object(let dict) = perm.toolInput,
           case .string(let cmd) = dict["command"] {
            #expect(cmd == "rm -rf /tmp/test")
        } else {
            Issue.record("Expected object toolInput with command field")
        }
    }

    @Test func decodePermissionRequestMinimal() throws {
        let json = """
        {"id":"perm_002","agentId":"durable_001","toolName":"Edit","deadline":1737000120000}
        """
        let perm = try JSONDecoder().decode(PermissionRequest.self, from: Data(json.utf8))
        #expect(perm.id == "perm_002")
        #expect(perm.toolName == "Edit")
        #expect(perm.toolInput == nil)
        #expect(perm.message == nil)
    }

    @Test func decodePermissionRequestPayload() throws {
        let json = """
        {"type":"permission:request","payload":{"requestId":"perm_001","agentId":"durable_001","toolName":"Bash","toolInput":null,"message":"Run command","deadline":1737000120000}}
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<PermissionRequestPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.requestId == "perm_001")
        #expect(msg.payload.agentId == "durable_001")
        #expect(msg.payload.toolName == "Bash")
        #expect(msg.payload.message == "Run command")
        #expect(msg.payload.deadline == 1737000120000)
    }

    @Test func encodePermissionResponseRequest() throws {
        let request = PermissionResponseRequest(requestId: "perm_001", decision: "allow")
        let data = try JSONEncoder().encode(request)
        let decoded = try JSONDecoder().decode(PermissionResponseRequest.self, from: data)
        #expect(decoded.requestId == "perm_001")
        #expect(decoded.decision == "allow")
    }

    @Test func encodePermissionResponseRequestDeny() throws {
        let request = PermissionResponseRequest(requestId: "perm_002", decision: "deny")
        let data = try JSONEncoder().encode(request)
        let decoded = try JSONDecoder().decode(PermissionResponseRequest.self, from: data)
        #expect(decoded.requestId == "perm_002")
        #expect(decoded.decision == "deny")
    }

    @Test func decodePermissionResponseResponse() throws {
        let json = """
        {"requestId":"perm_001","decision":"allow","delivered":true}
        """
        let response = try JSONDecoder().decode(PermissionResponseResponse.self, from: Data(json.utf8))
        #expect(response.requestId == "perm_001")
        #expect(response.decision == "allow")
        #expect(response.delivered == true)
    }

    @Test func permissionRequestIdentifiable() {
        let perm = PermissionRequest(
            id: "perm_001",
            agentId: "agent_1",
            toolName: "Bash",
            toolInput: nil,
            message: nil,
            deadline: 1737000120000
        )
        #expect(perm.id == "perm_001")
    }

    @Test func permissionRequestHashable() {
        let perm1 = PermissionRequest(id: "perm_001", agentId: "a1", toolName: "Bash", toolInput: nil, message: nil, deadline: 100)
        let perm2 = PermissionRequest(id: "perm_002", agentId: "a1", toolName: "Edit", toolInput: nil, message: nil, deadline: 200)
        let set: Set<PermissionRequest> = [perm1, perm2]
        #expect(set.count == 2)
    }
}

// MARK: - Permission WebSocket Tests

struct PermissionWSTests {
    @Test func decodePermissionRequestWSMessage() throws {
        let json = """
        {"type":"permission:request","payload":{"requestId":"perm_abc","agentId":"durable_001","toolName":"Write","toolInput":{"path":"/src/main.ts"},"message":"Write to file","deadline":1737000120000}}
        """
        let envelope = try JSONDecoder().decode(WSMessage.self, from: Data(json.utf8))
        #expect(envelope.type == "permission:request")

        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let msg = try JSONDecoder().decode(PayloadExtractor<PermissionRequestPayload>.self, from: Data(json.utf8))
        #expect(msg.payload.requestId == "perm_abc")
        #expect(msg.payload.toolName == "Write")
    }

    @Test func decodeSnapshotWithPendingPermissions() throws {
        let json = """
        {
            "type": "snapshot",
            "payload": {
                "projects": [],
                "agents": {},
                "theme": {"base":"#1e1e2e","mantle":"#181825","crust":"#11111b","text":"#cdd6f4","subtext0":"#a6adc8","subtext1":"#bac2de","surface0":"#313244","surface1":"#45475a","surface2":"#585b70","accent":"#89b4fa","link":"#89b4fa"},
                "orchestrators": {},
                "pendingPermissions": [
                    {"id":"perm_001","agentId":"agent_1","toolName":"Bash","message":"Run npm test","deadline":1737000120000}
                ]
            }
        }
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let snapshot = try JSONDecoder().decode(PayloadExtractor<SnapshotPayload>.self, from: Data(json.utf8))
        #expect(snapshot.payload.pendingPermissions?.count == 1)
        #expect(snapshot.payload.pendingPermissions?[0].id == "perm_001")
        #expect(snapshot.payload.pendingPermissions?[0].toolName == "Bash")
    }

    @Test func decodeSnapshotWithoutPendingPermissions() throws {
        let json = """
        {
            "type": "snapshot",
            "payload": {
                "projects": [],
                "agents": {},
                "theme": {"base":"#1e1e2e","mantle":"#181825","crust":"#11111b","text":"#cdd6f4","subtext0":"#a6adc8","subtext1":"#bac2de","surface0":"#313244","surface1":"#45475a","surface2":"#585b70","accent":"#89b4fa","link":"#89b4fa"},
                "orchestrators": {}
            }
        }
        """
        struct PayloadExtractor<T: Decodable>: Decodable { let payload: T }
        let snapshot = try JSONDecoder().decode(PayloadExtractor<SnapshotPayload>.self, from: Data(json.utf8))
        #expect(snapshot.payload.pendingPermissions == nil)
    }
}

// MARK: - AppStore Permission Tests

@MainActor
struct AppStorePermissionTests {
    @Test func pendingPermissionsEmptyByDefault() {
        let store = AppStore()
        #expect(store.pendingPermissions.isEmpty)
    }

    @Test func pendingPermissionForAgent() {
        let store = AppStore()
        let futureDeadline = Int(Date().timeIntervalSince1970 * 1000) + 60_000
        let perm = PermissionRequest(
            id: "perm_001",
            agentId: "agent_1",
            toolName: "Bash",
            toolInput: nil,
            message: "Run tests",
            deadline: futureDeadline
        )
        store.pendingPermissions["perm_001"] = perm

        let found = store.pendingPermission(for: "agent_1")
        #expect(found != nil)
        #expect(found?.id == "perm_001")
    }

    @Test func pendingPermissionReturnsNilForWrongAgent() {
        let store = AppStore()
        let futureDeadline = Int(Date().timeIntervalSince1970 * 1000) + 60_000
        let perm = PermissionRequest(
            id: "perm_001",
            agentId: "agent_1",
            toolName: "Bash",
            toolInput: nil,
            message: nil,
            deadline: futureDeadline
        )
        store.pendingPermissions["perm_001"] = perm

        let found = store.pendingPermission(for: "agent_2")
        #expect(found == nil)
    }

    @Test func expiredPermissionNotReturned() {
        let store = AppStore()
        let pastDeadline = Int(Date().timeIntervalSince1970 * 1000) - 1000
        let perm = PermissionRequest(
            id: "perm_expired",
            agentId: "agent_1",
            toolName: "Bash",
            toolInput: nil,
            message: nil,
            deadline: pastDeadline
        )
        store.pendingPermissions["perm_expired"] = perm

        let found = store.pendingPermission(for: "agent_1")
        #expect(found == nil)
    }

    @Test func disconnectClearsPendingPermissions() {
        let store = AppStore()
        store.loadMockData()
        let perm = PermissionRequest(
            id: "perm_001",
            agentId: "agent_1",
            toolName: "Bash",
            toolInput: nil,
            message: nil,
            deadline: 9999999999999
        )
        store.pendingPermissions["perm_001"] = perm
        #expect(!store.pendingPermissions.isEmpty)
        store.disconnect()
        #expect(store.pendingPermissions.isEmpty)
    }
}
